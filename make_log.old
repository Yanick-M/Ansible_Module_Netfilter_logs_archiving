- name: "Create firewall own log"
  hosts: Router

  handlers: 
    - name: "rsyslog restart"
      service:
        name: "rsyslog"
        state: "restarted"
    - name: "logrotate restart"
      service:
        name: "logrotate"
        state: "restarted"
    
  tasks:
    - name: "Configure rsyslog"
      own_logs:
        state: "present"
        IPTABLES_RULES_LIST: [
          "iptables -A INPUT -j LOG --log-prefix \"iptables_in: \"",
          "iptables -A FORWARD -j LOG --log-prefix \"iptables_fw: \"",
          "iptables -A OUTPUT -j LOG --log-prefix \"iptables_out: \"",
          "iptables -t nat -A PREROUTING -j LOG --log-prefix \"iptables_nat_prerout: \"",
          "iptables -t nat -A POSTROUTING -j LOG --log-prefix \"iptables_nat_postrout: \"",
          "iptables -t nat -A INPUT -j LOG --log-prefix \"iptables_nat_in: \"",
          "iptables -t nat -A OUTPUT -j LOG --log-prefix \"iptables_nat_out: \""
        ]
      register: result
      notify: rsyslog restart

    - debug: var=result

    - meta: flush_handlers

    - name: "Generate IP traffic"
      ping:

    - name: "Wait for log file"
      pause:
        seconds: 5
      connection: local

    - name: "Configure logrotate"
      logs_rotate:
        state: "absent"
        LOGROTATE_LIST: [
          "/var/log/netfilter/* {",
          "    daily",
          "    rotate 2",
          "}",
          ""
        ]
      register: result
      notify: logrotate restart

    - debug: var=result